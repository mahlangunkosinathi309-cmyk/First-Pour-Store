<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Checkout - First Pour</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>

<header class="top-bar">
  <div class="brand">
    <img class="logo" src="{{ url_for('static', filename='img/logo-first-pour.jpg') }}" alt="First Pour logo">
    <div>
      <div class="brand-title">FIRST POUR</div>
      <div class="brand-sub">Checkout</div>
    </div>
  </div>

  <a class="header-cta" href="/" >
    Back to store
  </a>
</header>

<section class="checkout">
  <div class="checkout-grid">
    <div class="panel">
      <h2>Your order</h2>
      {% if lines|length == 0 %}
        <p class="muted">Your cart is empty. Go back and add products.</p>
      {% else %}
        <ul class="summary">
          {% for L in lines %}
            <li>
              <div><strong>{{ L.name }}</strong><br><span class="muted small">x{{ L.qty }} · {{ L.unit_price }}</span></div>
              <div><strong>{{ L.line_total }}</strong></div>
            </li>
          {% endfor %}
        </ul>

        <div class="total-row">
          <div>Subtotal</div>
          <div><strong>R{{ (subtotal_cents/100)|round(0)|int }}</strong></div>
        </div>

        <div class="total-row" id="feeRow">
          <div id="feeLabel">Pickup</div>
          <div id="feeValue"><strong>Free</strong></div>
        </div>

        <div class="total">
          <div><strong>Total</strong></div>
          <div><strong id="totalValue">R{{ (subtotal_cents/100)|round(0)|int }}</strong></div>
        </div>
      {% endif %}
      <p class="muted small" style="margin-top:12px;">
        We confirm delivery & payment on WhatsApp. (Yoco coming soon)
      </p>
    </div>

    <div class="panel">
      <h2>Customer details</h2>

      <form method="POST" action="/place-order">
        <input type="hidden" name="cart_raw" value="{{ cart_raw }}"/>

        <label class="muted small">Full name</label>
        <input name="name" placeholder="e.g. Emmanuel" />

        <label class="muted small" style="margin-top:10px;">Phone number</label>
        <input name="phone" placeholder="e.g. 07X XXX XXXX" />

        <label class="muted small" style="margin-top:10px;">Delivery method</label>
        <select name="method" id="method" onchange="updateFee()">
          <option value="pickup">Pickup (Free)</option>
          <option value="delivery">Delivery (R80)</option>
        </select>

        <div id="addressBox" style="margin-top:10px; display:none;">
          <label class="muted small">Delivery address</label>
          <textarea name="address" placeholder="Street, suburb, city"></textarea>
        </div>

        <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap;">
          <button type="submit" class="btn btn-gold">Send order on WhatsApp</button>
          <a class="btn btn-outline" href="/">Back</a>
        </div>
      </form>

      <p class="muted small" style="margin-top:14px;">
        Not for sale to persons under the age of 18. Please drink responsibly.
      </p>
    </div>
  </div>
</section>

<script>
  const subtotal = {{ (subtotal_cents/100)|round(0)|int }};
  const deliveryFee = {{ (delivery_fee_cents/100)|round(0)|int }};

  function updateFee(){
    const method = document.getElementById("method").value;
    const feeLabel = document.getElementById("feeLabel");
    const feeValue = document.getElementById("feeValue");
    const totalValue = document.getElementById("totalValue");
    const addressBox = document.getElementById("addressBox");

    if(method === "delivery"){
      feeLabel.innerText = "Delivery";
      feeValue.innerHTML = "<strong>R" + deliveryFee + "</strong>";
      totalValue.innerText = "R" + (subtotal + deliveryFee);
      addressBox.style.display = "block";
    } else {
      feeLabel.innerText = "Pickup";
      feeValue.innerHTML = "<strong>Free</strong>";
      totalValue.innerText = "R" + subtotal;
      addressBox.style.display = "none";
    }
  }

  updateFee();
</script>

</body>
</html>
