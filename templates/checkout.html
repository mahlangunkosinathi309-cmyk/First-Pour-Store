<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Checkout - First Pour</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>

<header class="top-bar">
  <div class="brand">
    <img class="logo" src="{{ url_for('static', filename='img/logo-first-pour.jpg') }}" alt="First Pour logo">
    <div>
      <div class="brand-title">FIRST POUR</div>
      <div class="brand-sub">Checkout</div>
    </div>
  </div>

  <a class="header-cta" href="/" >
    Back to store<br><strong>Home</strong>
  </a>
</header>

<section class="checkout">
  <div class="checkout-grid">

    <div class="panel">
      <h2>Order Summary</h2>

      {% if lines|length == 0 %}
        <p class="muted">Your cart is empty. Go back and add products.</p>
      {% else %}
        <ul class="summary">
          {% for ln in lines %}
            <li>
              <span>{{ ln.qty }} x {{ ln.name }}</span>
              <strong>R{{ "%.2f"|format(ln.line_cents / 100) }}</strong>
            </li>
          {% endfor %}
        </ul>

        <div class="total-row">
          <span>Subtotal</span>
          <strong id="subtotalText">R{{ "%.2f"|format(subtotal_cents / 100) }}</strong>
        </div>

        <div class="total-row">
          <span>Delivery</span>
          <strong id="deliveryText">R0.00</strong>
        </div>

        <div class="total">
          <span>Total</span>
          <strong id="totalText">R{{ "%.2f"|format(subtotal_cents / 100) }}</strong>
        </div>

        <p class="muted small">Payment: EFT / Cash for now (Yoco can be added later).</p>
      {% endif %}
    </div>

    <div class="panel">
      <h2>Delivery Details</h2>

      {% if lines|length == 0 %}
        <p class="muted">Nothing to checkout.</p>
      {% else %}
      <form method="POST" action="/checkout">
        <input type="hidden" name="cart_raw" value='{{ cart_raw }}'>
        <input type="hidden" id="delivery_method" name="delivery_method" value="pickup">

        <label>Name</label>
        <input name="name" required>

        <label>Phone</label>
        <input name="phone" required>

        <label>Method</label>
        <select id="methodSelect" onchange="updateDelivery()">
          <option value="pickup">Pickup (R0)</option>
          <option value="delivery">Delivery (R{{ "%.0f"|format(delivery_fee_cents / 100) }})</option>
        </select>

        <div id="addressWrap" style="display:none;">
          <label>Address</label>
          <textarea name="address" id="addressBox"></textarea>
        </div>

        <button class="btn btn-gold" type="submit">Place Order on WhatsApp</button>
        <p class="muted small">We will confirm delivery and payment on WhatsApp.</p>
      </form>
      {% endif %}
    </div>

  </div>
</section>

<script>
  const subtotal = {{ subtotal_cents }};
  const deliveryFee = {{ delivery_fee_cents }};

  function centsToRand(c){
    return "R" + (c/100).toFixed(2);
  }

  function updateDelivery(){
    const method = document.getElementById("methodSelect").value;
    document.getElementById("delivery_method").value = method;

    const addressWrap = document.getElementById("addressWrap");
    const addressBox  = document.getElementById("addressBox");

    let delivery = 0;
    if(method === "delivery"){
      delivery = deliveryFee;
      addressWrap.style.display = "block";
      addressBox.required = true;
    } else {
      addressWrap.style.display = "none";
      addressBox.required = false;
      addressBox.value = "";
    }

    document.getElementById("deliveryText").innerText = centsToRand(delivery);
    document.getElementById("totalText").innerText = centsToRand(subtotal + delivery);
  }

  updateDelivery();
</script>

</body>
</html>
